---
phase: 03-phase-execution
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - templates/PROTOCOL-PROMPT.md.template
  - lib/prompt.sh
  - lib/commands/execute.sh
  - bin/gsd-ralph
  - tests/execute.bats
autonomous: true
---

<objective>
Implement `gsd-ralph execute N` that creates a branch, generates a GSD-protocol PROMPT.md, combined fix_plan.md, and execution log — preparing the environment for Ralph to autonomously complete all plans in the phase.

Purpose: Deliver the execute command with sequential mode, using the frontmatter/strategy foundation from Plan 03-01.
Output: Working execute command with protocol template, integration tests, and updated CLI.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-phase-execution/03-01-PLAN.md
@lib/common.sh
@lib/discovery.sh
@lib/frontmatter.sh
@lib/strategy.sh
@lib/prompt.sh
@lib/templates.sh
@lib/commands/generate.sh
@.ralph/PROMPT.md
@tests/test_helper/common.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PROTOCOL-PROMPT.md.template</name>
  <files>templates/PROTOCOL-PROMPT.md.template</files>
  <action>
Create `templates/PROTOCOL-PROMPT.md.template` based on the Phase 2 `.ralph/PROMPT.md` but project-agnostic. Contains:
- 7-step GSD Execution Protocol (orient, locate, execute, verify, commit, update state, check completion)
- GSD file permissions table
- Execution log requirement with format
- Plan summary format
- Status reporting / EXIT_SIGNAL criteria
- Variables: {{PROJECT_NAME}}, {{PROJECT_LANG}}, {{TEST_CMD}}, {{BUILD_CMD}}

Project-specific constraints (e.g., Bash 3.2) are NOT in this template — Ralph reads those from PROJECT.md or AGENT.md.
  </action>
  <verify>
    - Template contains "GSD Execution Protocol"
    - Template contains "File Permissions" table
    - Template contains {{PROJECT_NAME}}, {{TEST_CMD}}, {{BUILD_CMD}} placeholders
    - No hardcoded project-specific content
  </verify>
  <done>PROTOCOL-PROMPT.md.template is a reusable, project-agnostic protocol template with all necessary GSD execution instructions.</done>
</task>

<task type="auto">
  <name>Task 2: Add protocol prompt and combined fix_plan generation to lib/prompt.sh</name>
  <files>lib/prompt.sh</files>
  <action>
Add two new functions to lib/prompt.sh:

1. `generate_protocol_prompt_md(output_path, template_path, phase_num, phase_dir, project_name, project_lang, test_cmd, build_cmd, plan_files...)` — renders protocol template, then appends phase context section (plan list, task summary, execution order, mode)

2. `generate_combined_fix_plan(phase_dir, output_path, plan_files...)` — iterates all plans in order, extracts tasks via extract_tasks_to_fix_plan(), writes grouped fix_plan.md with plan headers and summary creation tasks
  </action>
  <verify>
    - `shellcheck -s bash lib/prompt.sh` passes
    - Both functions exist and are callable
  </verify>
  <done>lib/prompt.sh has generate_protocol_prompt_md() and generate_combined_fix_plan() ready for the execute command.</done>
</task>

<task type="auto">
  <name>Task 3: Implement cmd_execute in lib/commands/execute.sh</name>
  <files>lib/commands/execute.sh, bin/gsd-ralph, tests/execute.bats</files>
  <action>
Replace the stub in lib/commands/execute.sh with the full implementation:

1. Validate: git repo, .planning/ exists, .ralph/ exists
2. Find phase directory, discover plans
3. Analyze strategy (sequential/parallel — report mode to user)
4. If parallel-capable: print info, proceed with sequential
5. Detect project type (for template variables)
6. Create and switch to branch: phase-N/slug
7. Generate protocol PROMPT.md → .ralph/PROMPT.md
8. Generate combined fix_plan.md → .ralph/fix_plan.md
9. Initialize execution log → .ralph/logs/execution-log.md
10. Update .planning/STATE.md
11. Commit: chore(phase-N): set up execution environment
12. Print summary and launch instructions

Support --dry-run (show without creating) and -v/--verbose.

Update bin/gsd-ralph usage text. Write tests/execute.bats with ~17 integration tests.
  </action>
  <verify>
    - `shellcheck -s bash lib/commands/execute.sh` passes
    - `./tests/bats/bin/bats tests/execute.bats` — all tests pass
    - `make check` passes (all 125+ tests)
    - At least 15 test cases in execute.bats
  </verify>
  <done>gsd-ralph execute N creates branch, generates protocol PROMPT.md, combined fix_plan.md, execution log. 15+ integration tests pass.</done>
</task>

</tasks>

<verification>
1. `make check` passes (lint + all tests including new execute.bats)
2. `gsd-ralph execute 2` (against this project's Phase 2) produces correct branch, PROMPT.md, fix_plan.md
3. Protocol PROMPT.md contains the 7-step GSD Execution Protocol
4. Combined fix_plan.md has tasks grouped by plan with summary tasks
5. Strategy analysis correctly identifies Phase 2 as sequential
6. No bash 4+ features in any new code
</verification>

<success_criteria>
- EXEC-01 (adapted): execute creates execution environment (branch, not worktree)
- EXEC-05: user receives clear launch instructions
- Generated PROMPT.md enforces GSD discipline via the 7-step protocol
- Combined fix_plan.md groups tasks by plan with summary creation tasks
- All existing tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-phase-execution/03-02-SUMMARY.md`
</output>

---
phase: 03-phase-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/frontmatter.sh
  - lib/strategy.sh
  - tests/frontmatter.bats
  - tests/strategy.bats
autonomous: true
---

<objective>
Build the foundation modules that parse GSD plan frontmatter and determine the execution strategy for a phase. By the end, gsd-ralph can extract wave/dependency metadata from any plan file and classify a phase as sequential or parallel-capable.

Purpose: Establish lib/frontmatter.sh (YAML frontmatter parser) and lib/strategy.sh (execution strategy analyzer) that the execute command (Plan 03-02) will consume.
Output: Working frontmatter parser and strategy analyzer with comprehensive unit tests.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-prompt-generation/02-01-PLAN.md
@lib/common.sh
@lib/discovery.sh
@tests/test_helper/common.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/frontmatter.sh with YAML frontmatter parser</name>
  <files>lib/frontmatter.sh, tests/frontmatter.bats</files>
  <action>
Create `lib/frontmatter.sh` implementing `parse_plan_frontmatter(plan_file)` that sets globals: FM_WAVE, FM_DEPENDS_ON (space-separated), FM_FILES_MODIFIED (space-separated), FM_PHASE, FM_PLAN, FM_TYPE.

Simple line-by-line parsing between `---` markers. Handle: scalar values, quoted strings, inline YAML arrays (`["a", "b"]`), multi-line YAML lists (`- item` format). No external YAML parser needed — GSD frontmatter is simple key: value format.

Write tests/frontmatter.bats with tests covering: extract wave, phase, plan, type; inline array depends_on; quoted array depends_on; empty depends_on; files_modified multi-line list; files_modified inline array; missing fields; no frontmatter; missing file; globals reset between calls; real plan file parsing.
  </action>
  <verify>
    - `shellcheck -s bash lib/frontmatter.sh` passes clean
    - `./tests/bats/bin/bats tests/frontmatter.bats` — all tests pass
    - At least 10 test cases in frontmatter.bats
  </verify>
  <done>lib/frontmatter.sh parses GSD frontmatter into globals. 10+ tests pass. ShellCheck clean. Bash 3.2 compatible.</done>
</task>

<task type="auto">
  <name>Task 2: Create lib/strategy.sh with execution strategy analyzer</name>
  <files>lib/strategy.sh, tests/strategy.bats</files>
  <action>
Create `lib/strategy.sh` implementing:
- `analyze_phase_strategy(phase_dir)` → sets STRATEGY_MODE ("sequential"|"parallel"), STRATEGY_WAVE_COUNT, STRATEGY_PLAN_ORDER (array)
- `validate_phase_dependencies(phase_dir)` → returns 0 if valid, 1 if circular deps or missing refs
- `print_phase_structure(phase_dir)` → human-readable summary

Sequential if: all plans form a linear chain (each wave has exactly 1 plan). Parallel if: any wave has >1 independent plan.

Write tests/strategy.bats covering: sequential detection, parallel detection, wave counting, plan order, single-plan phase, empty directory, valid deps, missing deps, circular deps, structure printing.
  </action>
  <verify>
    - `shellcheck -s bash lib/strategy.sh` passes clean
    - `./tests/bats/bin/bats tests/strategy.bats` — all tests pass
    - At least 10 test cases in strategy.bats
  </verify>
  <done>lib/strategy.sh analyzes phase structure and validates dependencies. 10+ tests pass. ShellCheck clean. Bash 3.2 compatible.</done>
</task>

</tasks>

<verification>
1. `shellcheck -s bash lib/frontmatter.sh lib/strategy.sh` passes
2. `make check` passes (lint + all tests)
3. Combined 20+ test cases across frontmatter.bats and strategy.bats
4. No bash 4+ features in any new code
</verification>

<success_criteria>
- WAVE-01 (partial): frontmatter parsing extracts wave and depends_on metadata
- Strategy analysis correctly classifies sequential vs parallel phases
- Dependency validation catches circular refs and missing deps
- All existing tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-phase-execution/03-01-SUMMARY.md`
</output>

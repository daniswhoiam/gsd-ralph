---
phase: 01-project-initialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/gsd-ralph
  - lib/common.sh
  - lib/config.sh
  - lib/templates.sh
  - templates/ralphrc.template
  - Makefile
  - tests/test_helper/common.bash
  - tests/common.bats
  - tests/config.bats
autonomous: true

must_haves:
  truths:
    - "bin/gsd-ralph runs and shows help text with all 5 subcommands listed"
    - "bin/gsd-ralph --version prints version string"
    - "lib/common.sh provides print_success, print_error, print_warning, print_info, die, check_dependency functions"
    - "lib/config.sh detect_project_type correctly identifies at least Node/TS, Rust, Go, Python projects"
    - "lib/templates.sh render_template substitutes {{VARIABLE}} placeholders in template files"
    - "make test runs bats tests successfully"
    - "make lint runs ShellCheck on all bash source files"
  artifacts:
    - path: "bin/gsd-ralph"
      provides: "CLI entry point with subcommand dispatch"
      contains: "case.*COMMAND"
    - path: "lib/common.sh"
      provides: "Output functions, dependency checking, utilities"
      contains: "check_dependency"
    - path: "lib/config.sh"
      provides: "Project type detection"
      contains: "detect_project_type"
    - path: "lib/templates.sh"
      provides: "Template rendering with variable substitution"
      contains: "render_template"
    - path: "Makefile"
      provides: "test, lint, check, install targets"
      contains: "test:"
    - path: "tests/test_helper/common.bash"
      provides: "Shared test setup with bats library loading"
      contains: "_common_setup"
  key_links:
    - from: "bin/gsd-ralph"
      to: "lib/common.sh"
      via: "source"
      pattern: 'source.*lib/common\.sh'
    - from: "bin/gsd-ralph"
      to: "lib/config.sh"
      via: "source"
      pattern: 'source.*lib/config\.sh'
    - from: "bin/gsd-ralph"
      to: "lib/commands/*.sh"
      via: "source and dispatch"
      pattern: 'source.*COMMAND_FILE'
    - from: "Makefile"
      to: "tests/*.bats"
      via: "bats test runner"
      pattern: 'bats tests/'
---

<objective>
Build the complete CLI skeleton for gsd-ralph: entry point with subcommand dispatch, shared library modules (output, dependency checking, project detection, template rendering), Makefile, and bats-core test infrastructure with unit tests.

Purpose: Establish the foundation that every subsequent phase builds on. Getting the lib module structure, output conventions, and test infrastructure right now prevents rework later.
Output: Working CLI entry point, 4 library modules, Makefile, bats test suite with passing tests.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-initialization/01-RESEARCH.md
@templates/ralphrc.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point and core library modules</name>
  <files>bin/gsd-ralph, lib/common.sh, lib/config.sh</files>
  <action>
Create the CLI entry point and two core shared libraries. Follow the patterns exactly as specified in 01-RESEARCH.md.

**bin/gsd-ralph** (chmod +x):
- Hashbang: `#!/bin/bash` (not `#!/usr/bin/env bash` -- ensures macOS system bash 3.2)
- `set -euo pipefail`
- Self-location via `BASH_SOURCE[0]` to find GSD_RALPH_HOME
- Source lib/common.sh and lib/config.sh
- GSD_RALPH_VERSION="0.1.0"
- Global option parsing: `-h/--help`, `--version`, `-v/--verbose`
- Subcommand dispatch via `case` statement that sources `lib/commands/${COMMAND}.sh` and calls `cmd_${COMMAND} "$@"`
- Usage text listing all 5 commands: init, execute, status, merge, cleanup
- Unknown command/option shows error and usage

**lib/common.sh**:
- Terminal detection `[[ -t 1 ]]` for color support (RED, GREEN, YELLOW, BLUE, BOLD, NC)
- Output functions: `print_header`, `print_success`, `print_warning`, `print_error` (to stderr), `print_info`, `print_verbose` (checks VERBOSE var)
- `die()` function (print_error + exit)
- `iso_timestamp()` using `date -u +%Y-%m-%dT%H:%M:%SZ` (portable)
- `check_dependency()` taking cmd name, install hint, optional min_version. Returns 1 if missing, prints actionable install instruction.
- `check_all_dependencies()` checking git, jq, python3. For `ralph`: print warning instead of error (per research recommendation -- ralph only needed at execute time, not init). Return failure count of hard dependencies only.
- All variables inside functions declared with `local`
- No bash 4+ features (no associative arrays, no readarray, no ${var,,})

**lib/config.sh**:
- `detect_project_type()` taking optional project_dir (defaults to ".")
- Check marker files in priority order: package.json (+ tsconfig.json for TS), Cargo.toml, go.mod, pyproject.toml, requirements.txt/setup.py, Makefile, Gemfile, mix.exs, build.gradle/build.gradle.kts, pom.xml
- For Node/TS: use jq to read scripts.test and scripts.build from package.json, detect package manager from lockfiles (pnpm-lock.yaml, yarn.lock, bun.lockb/bun.lock)
- Export results via global vars: DETECTED_LANG, DETECTED_TEST_CMD, DETECTED_BUILD_CMD, DETECTED_PKG_MANAGER (bash 3.2 compatible, no nameref)
- Default to "unknown" for unrecognized projects (XCUT-01 -- tool works regardless of stack)
- All code follows bash 3.2 patterns from the research anti-patterns list

Create placeholder command files for future phases so the dispatch does not break:
- `lib/commands/execute.sh` -- stub with `cmd_execute() { die "Not yet implemented. Coming in Phase 3."; }`
- `lib/commands/status.sh` -- stub with `cmd_status() { die "Not yet implemented."; }`
- `lib/commands/merge.sh` -- stub with `cmd_merge() { die "Not yet implemented. Coming in Phase 4."; }`
- `lib/commands/cleanup.sh` -- stub with `cmd_cleanup() { die "Not yet implemented. Coming in Phase 5."; }`

Ensure `bin/gsd-ralph` is executable: `chmod +x bin/gsd-ralph`.
  </action>
  <verify>
Run `bin/gsd-ralph --help` and confirm it shows usage with all 5 commands.
Run `bin/gsd-ralph --version` and confirm it prints "gsd-ralph v0.1.0".
Run `bin/gsd-ralph badcommand` and confirm it exits with error.
Run `bin/gsd-ralph init` -- will fail (init.sh not yet created) but should attempt to source the file, confirming dispatch works.
Run ShellCheck on all created files: `shellcheck -s bash bin/gsd-ralph lib/common.sh lib/config.sh`.
  </verify>
  <done>
bin/gsd-ralph shows help, reports version, dispatches subcommands. lib/common.sh and lib/config.sh pass ShellCheck. All functions use `local` variables. No bash 4+ features present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create template rendering library, parameterize ralphrc template, and create Makefile</name>
  <files>lib/templates.sh, templates/ralphrc.template, Makefile</files>
  <action>
**lib/templates.sh**:
- `render_template()` taking template path, output path, then KEY=VALUE pairs as remaining args
- Read template content with `content=$(<"$template")`
- Iterate over KEY=VALUE pairs, split on first `=`, substitute `{{KEY}}` with value using bash parameter expansion: `content="${content//\{\{${key}\}\}/${value}}"`
- Write result to output file with `printf '%s\n' "$content" > "$output"`
- Die if template file not found
- All variables declared with `local`

**templates/ralphrc.template** -- Parameterize the existing template:
Replace hardcoded values with `{{VARIABLE}}` placeholders. The template should use these variables:
- `{{PROJECT_NAME}}` (detected from git repo name or directory name)
- `{{PROJECT_TYPE}}` (from detect_project_type)
- `{{TEST_CMD}}` (from detect_project_type, or empty string)
- `{{BUILD_CMD}}` (from detect_project_type, or empty string)
Keep all the other config sections (loop settings, tool permissions, session management, circuit breaker) with their current default values. Keep the comments explaining each section. Add a comment at the top: `# Generated by: gsd-ralph init`.

**Makefile**:
- `BATS := ./tests/bats/bin/bats`
- `SHELLCHECK := shellcheck`
- `SRC_FILES` using wildcard for bin/gsd-ralph, lib/*.sh, lib/commands/*.sh
- Targets: `test` (run bats), `lint` (run shellcheck), `check` (lint + test), `install` (symlink bin/gsd-ralph to /usr/local/bin), `uninstall` (remove symlink)
- `.PHONY` declarations for all targets
- Default target: `check`
  </action>
  <verify>
Run ShellCheck on lib/templates.sh: `shellcheck -s bash lib/templates.sh`.
Verify templates/ralphrc.template contains `{{PROJECT_NAME}}`, `{{PROJECT_TYPE}}`, `{{TEST_CMD}}`, `{{BUILD_CMD}}` placeholders.
Verify Makefile has test, lint, check, install targets: `make -n test` and `make -n lint` show the expected commands (dry run).
  </verify>
  <done>
lib/templates.sh passes ShellCheck and provides render_template function. ralphrc.template uses {{VARIABLE}} placeholders instead of hardcoded values. Makefile targets work in dry-run mode.
  </done>
</task>

<task type="auto">
  <name>Task 3: Set up bats-core test infrastructure and write unit tests</name>
  <files>tests/test_helper/common.bash, tests/common.bats, tests/config.bats</files>
  <action>
**Set up bats-core as git submodules:**
```
git submodule add https://github.com/bats-core/bats-core.git tests/bats
git submodule add https://github.com/bats-core/bats-support.git tests/test_helper/bats-support
git submodule add https://github.com/bats-core/bats-assert.git tests/test_helper/bats-assert
git submodule add https://github.com/bats-core/bats-file.git tests/test_helper/bats-file
```

**tests/test_helper/common.bash:**
- `_common_setup()`: load bats-support, bats-assert, bats-file; resolve PROJECT_ROOT from BATS_TEST_DIRNAME; add bin/ to PATH; create TEST_TEMP_DIR with mktemp -d; cd into it
- `_common_teardown()`: rm -rf TEST_TEMP_DIR if it exists
- `create_test_repo()`: git init, git commit --allow-empty -m "Initial commit"
- `create_gsd_structure()`: mkdir -p .planning/phases, create minimal ROADMAP.md and STATE.md

**tests/common.bats** -- Unit tests for lib/common.sh:
- Test print_success outputs "[ok]" prefix
- Test print_error outputs "[error]" prefix to stderr
- Test print_warning outputs "[warn]" prefix
- Test die exits with code 1 and prints error
- Test check_dependency succeeds for "git" (should be available)
- Test check_dependency fails for "nonexistent_tool_xyz" with install hint in output
- Test iso_timestamp returns ISO 8601 format (match pattern YYYY-MM-DDTHH:MM:SSZ)

NOTE: For testing lib functions directly, source lib/common.sh in the test setup. Set VERBOSE=false. Tests must run in isolated temp directories.

**tests/config.bats** -- Unit tests for lib/config.sh:
- Test detect_project_type with package.json -> detects "javascript"
- Test detect_project_type with package.json + tsconfig.json -> detects "typescript"
- Test detect_project_type with Cargo.toml -> detects "rust"
- Test detect_project_type with go.mod -> detects "go"
- Test detect_project_type with pyproject.toml -> detects "python"
- Test detect_project_type with no marker files -> detects "unknown"
- Test detect_project_type reads test command from package.json scripts.test via jq
- Test detect_project_type detects pnpm from pnpm-lock.yaml

For each test: setup creates temp dir, creates the marker file(s), sources lib/config.sh, calls detect_project_type, asserts DETECTED_LANG matches expected value.

Run `make check` at the end to verify lint + tests pass together.
  </action>
  <verify>
Run `make test` -- all bats tests pass.
Run `make lint` -- all source files pass ShellCheck.
Run `make check` -- both lint and test pass.
Verify git submodules are registered: `git submodule status` shows 4 submodules.
  </verify>
  <done>
bats-core installed as git submodules. tests/test_helper/common.bash provides shared setup/teardown. tests/common.bats has 7+ passing tests for lib/common.sh. tests/config.bats has 8+ passing tests for lib/config.sh. `make check` passes (lint + test).
  </done>
</task>

</tasks>

<verification>
1. `bin/gsd-ralph --help` shows usage with all 5 subcommands
2. `bin/gsd-ralph --version` shows "gsd-ralph v0.1.0"
3. `make check` passes (ShellCheck lint + bats tests)
4. `git submodule status` shows 4 bats submodules
5. All .sh files pass `shellcheck -s bash`
6. No bash 4+ features: `grep -rn 'declare -A\|readarray\|mapfile\|\${.*,,}\|\${.*\^\^}\||&' lib/ bin/` returns nothing
</verification>

<success_criteria>
- CLI entry point dispatches to subcommand handlers and shows help/version
- lib/common.sh provides all output and dependency-checking functions
- lib/config.sh detects project type for Node/TS, Rust, Go, Python, and unknown
- lib/templates.sh renders templates with {{VARIABLE}} substitution
- templates/ralphrc.template is parameterized with project-specific placeholders
- Makefile provides test, lint, check, install targets
- bats-core test infrastructure is set up with git submodules
- Unit tests for common.sh and config.sh all pass
- ShellCheck passes on all source files
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-initialization/01-01-SUMMARY.md`
</output>

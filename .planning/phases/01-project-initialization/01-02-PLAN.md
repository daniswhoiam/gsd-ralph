---
phase: 01-project-initialization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lib/commands/init.sh
  - tests/init.bats
autonomous: true

must_haves:
  truths:
    - "User can run gsd-ralph init in a GSD project and get a .ralph/ directory with config files"
    - "User sees actionable error message when running init outside a git repo"
    - "User sees actionable error message when running init without .planning/ directory"
    - "User sees actionable error messages for each missing hard dependency (git, jq, python3)"
    - "User sees a warning (not error) when ralph is not installed"
    - "Init auto-detects project language and shows it in output"
    - "Init creates .ralphrc in project root with detected test/build commands"
    - "Init is idempotent: refuses to reinitialize without --force, succeeds with --force"
    - "Init works on Node/TS, Rust, Go, Python projects and unknown stacks"
  artifacts:
    - path: "lib/commands/init.sh"
      provides: "Complete init command implementation"
      contains: "cmd_init"
    - path: "tests/init.bats"
      provides: "Integration tests for init command"
      min_lines: 80
  key_links:
    - from: "lib/commands/init.sh"
      to: "lib/common.sh"
      via: "check_all_dependencies call"
      pattern: "check_all_dependencies"
    - from: "lib/commands/init.sh"
      to: "lib/config.sh"
      via: "detect_project_type call"
      pattern: "detect_project_type"
    - from: "lib/commands/init.sh"
      to: "lib/templates.sh"
      via: "render_template call"
      pattern: "render_template"
    - from: "lib/commands/init.sh"
      to: "templates/ralphrc.template"
      via: "template rendering to .ralphrc"
      pattern: "ralphrc.template"
    - from: "bin/gsd-ralph"
      to: "lib/commands/init.sh"
      via: "subcommand dispatch"
      pattern: "source.*init\\.sh"
---

<objective>
Implement the complete `gsd-ralph init` command and comprehensive integration tests. This is the user-facing feature of Phase 1 -- by the end, a user can run `gsd-ralph init` in any GSD project and get a working configuration.

Purpose: Deliver requirements INIT-01 (init command), INIT-02 (dependency validation), INIT-03 (project type detection), and XCUT-01 (stack-agnostic).
Output: Working init command, comprehensive integration test suite, all tests passing.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-initialization/01-RESEARCH.md
@.planning/phases/01-project-initialization/01-01-SUMMARY.md
@templates/ralphrc.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the gsd-ralph init command</name>
  <files>lib/commands/init.sh</files>
  <action>
Create lib/commands/init.sh implementing the full init command. This replaces the stub created in Plan 01-01. Follow the Pattern 5 (Init Command Structure) from 01-RESEARCH.md.

**cmd_init() function flow:**

1. **Parse init-specific options:** `-f/--force` flag, `-h/--help` for init_usage
2. **Validate git repo:** `git rev-parse --is-inside-work-tree` or die with "Not inside a git repository. Run this from your project root."
3. **Check for GSD planning directory:** `[[ -d ".planning" ]]` or die with "No .planning/ directory found. Initialize GSD first."
4. **Check if already initialized:** If `.ralph/` exists and force is false, print warning ".ralph/ directory already exists. Use --force to reinitialize." and exit 0 (not error).
5. **Check dependencies:** Call `check_all_dependencies`. Exit 1 if any hard dependencies missing. Ralph being missing should only produce a warning (this is handled in common.sh from Plan 01-01).
6. **Detect project type:** Call `detect_project_type "."`. Print detected language, test command, build command, package manager using print_success for each found value.
7. **Derive project name:** Use `basename "$(git rev-parse --show-toplevel)"` to get the project name from the git root directory name.
8. **Create .ralph/ directory structure:** `mkdir -p .ralph/logs`
9. **Render .ralphrc:** Source lib/templates.sh (it should already be available via entry point sourcing, but source explicitly if needed for safety). Call render_template with the ralphrc.template and output to `.ralphrc` in project root, passing: PROJECT_NAME, PROJECT_TYPE (DETECTED_LANG), TEST_CMD (DETECTED_TEST_CMD or empty), BUILD_CMD (DETECTED_BUILD_CMD or empty).
10. **Print completion summary:** Use print_header "Initialization complete", then print_success for what was created, and print_info with next steps (review .ralphrc, plan phase with GSD, run gsd-ralph execute).

**init_usage() function:**
Print init-specific help: description, usage line, options (-f/--force, -h/--help).

**Important implementation details:**
- Source lib/templates.sh at the top of cmd_init (or at file level) so render_template is available
- All variables must use `local`
- No bash 4+ features
- Error messages must be actionable (tell user what to do, not just what went wrong)
- The function must handle the case where jq is missing gracefully during project detection (detect_project_type should still work but may not read package.json scripts)
  </action>
  <verify>
Run ShellCheck: `shellcheck -s bash lib/commands/init.sh`
Manually test in the project root (which is a GSD project):
- `bin/gsd-ralph init` should succeed, create .ralph/ and .ralphrc
- `bin/gsd-ralph init` again should warn about existing .ralph/
- `bin/gsd-ralph init --force` should succeed and overwrite
- Check .ralphrc contains project-detected values (not {{VARIABLE}} placeholders)
- `cd /tmp && /path/to/bin/gsd-ralph init` should fail with git repo error
  </verify>
  <done>
gsd-ralph init creates .ralph/ directory and .ralphrc with auto-detected project settings. Actionable errors for missing git repo, missing .planning/, missing dependencies. Warning for missing ralph. Idempotent with --force. ShellCheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive integration tests for the init command</name>
  <files>tests/init.bats</files>
  <action>
Create tests/init.bats with comprehensive integration tests covering all init command scenarios. Each test creates an isolated temp directory with a fresh git repo and GSD structure.

**Test setup/teardown:**
- setup(): load test_helper/common, call _common_setup, create_test_repo, create_gsd_structure
- teardown(): call _common_teardown

**Required test cases (minimum):**

Success scenarios:
1. "init creates .ralph directory" -- run gsd-ralph init, assert_success, assert_dir_exists ".ralph"
2. "init creates .ralph/logs directory" -- assert_dir_exists ".ralph/logs"
3. "init creates .ralphrc in project root" -- assert_file_exists ".ralphrc"
4. "init .ralphrc contains project name" -- run init, check .ralphrc contains the project name (basename of temp dir)
5. "init detects typescript project" -- create package.json with test script + tsconfig.json, run init, assert output contains "typescript"
6. "init detects rust project" -- create Cargo.toml, run init, assert output contains "rust"
7. "init detects go project" -- create go.mod, run init, assert output contains "go"
8. "init detects python project" -- create pyproject.toml, run init, assert output contains "python"
9. "init handles unknown project type" -- no marker files, run init, assert_success (should still work per XCUT-01)
10. "init .ralphrc has no unresolved placeholders" -- run init, grep for "{{" in .ralphrc, refute any match

Failure scenarios:
11. "init fails outside git repo" -- cd to non-git temp dir, run init, assert_failure, assert_output --partial "Not inside a git repository"
12. "init fails without .planning directory" -- rm -rf .planning, run init, assert_failure, assert_output --partial ".planning"

Idempotency:
13. "init warns when .ralph already exists" -- run init twice, second run should assert_success with output containing "already exists"
14. "init succeeds with --force when .ralph exists" -- run init, run init --force, assert_success
15. "init --force overwrites .ralphrc" -- run init, modify .ralphrc, run init --force, verify .ralphrc is regenerated

Dependency checking:
16. "init checks for required dependencies" -- run init with severely restricted PATH (only /usr/bin:/bin to ensure some tool is missing), verify it reports missing dependencies. NOTE: Be careful -- git must still be available for the git repo check to pass first. If this test is too fragile due to PATH manipulation, test dependency checking by directly calling check_dependency with a fake tool name instead.

**After writing tests, run the full suite:**
- `make check` (lint + test)
- Verify all tests pass
- Fix any issues found during testing

If any tests reveal bugs in the init command or library functions, fix those bugs in the appropriate files (lib/commands/init.sh, lib/common.sh, etc.) as part of this task.
  </action>
  <verify>
Run `make test` -- all tests pass (including both common.bats, config.bats from Plan 01-01 and the new init.bats).
Run `make check` -- lint + test both pass.
Count test cases: `grep -c '@test' tests/init.bats` should be >= 14.
  </verify>
  <done>
tests/init.bats has 14+ passing integration tests covering success, failure, idempotency, and dependency scenarios. All tests run in isolation with temp directories. `make check` passes. No regressions in common.bats or config.bats.
  </done>
</task>

</tasks>

<verification>
1. `bin/gsd-ralph init` in this project creates .ralph/ and .ralphrc with sensible defaults
2. `bin/gsd-ralph init` outside a git repo shows actionable error
3. `bin/gsd-ralph init` without .planning/ shows actionable error
4. `.ralphrc` contains auto-detected project settings (no unresolved {{}} placeholders)
5. `bin/gsd-ralph init --force` reinitializes successfully
6. `make check` passes (all ShellCheck + all bats tests)
7. Test count >= 14 integration tests in init.bats
</verification>

<success_criteria>
- INIT-01: `gsd-ralph init` creates .ralph/ config directory with sensible defaults -- VERIFIED by tests 1-4 and manual run
- INIT-02: Actionable error messages for missing dependencies -- VERIFIED by dependency tests
- INIT-03: Auto-detects language, test command, build tool -- VERIFIED by project type tests (TS, Rust, Go, Python)
- XCUT-01: Works regardless of tech stack -- VERIFIED by unknown project type test (init succeeds with no marker files)
- All tests passing, ShellCheck clean, no bash 4+ features
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-initialization/01-02-SUMMARY.md`
</output>

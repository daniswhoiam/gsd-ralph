---
phase: 04-merge-orchestration
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - lib/commands/merge.sh
  - lib/merge/review.sh
  - tests/merge.bats
autonomous: true
requirements: [MERG-01, MERG-02, MERG-03]

must_haves:
  truths:
    - "gsd-ralph merge N merges all completed branches for the phase into main in plan order"
    - "When a merge conflict cannot be auto-resolved, the branch is skipped and remaining branches continue"
    - "User sees a dry-run report showing which branches will merge cleanly vs conflict before any merge happens"
    - "User sees a post-merge summary table with branch name, status (merged/skipped/conflicted), files changed, commits"
    - "gsd-ralph merge N --review shows full git diffs for each merged branch in addition to the summary"
    - "User sees clear conflict guidance listing conflicting file names when a branch is skipped"
  artifacts:
    - path: "lib/commands/merge.sh"
      provides: "Complete merge pipeline with dry-run preflight, sequential merge loop, skip-on-failure, and summary"
      min_lines: 150
    - path: "lib/merge/review.sh"
      provides: "Post-merge review output with summary table and optional full diffs"
      min_lines: 40
    - path: "tests/merge.bats"
      provides: "Extended tests covering merge pipeline, conflict skip, review output"
      min_lines: 120
  key_links:
    - from: "lib/commands/merge.sh"
      to: "lib/merge/review.sh"
      via: "source and print_merge_summary call"
      pattern: "source.*merge/review"
    - from: "lib/commands/merge.sh"
      to: "lib/merge/dry_run.sh"
      via: "merge_dry_run call in preflight loop"
      pattern: "merge_dry_run.*branch"
    - from: "lib/commands/merge.sh"
      to: "lib/merge/auto_resolve.sh"
      via: "auto_resolve_known_conflicts call after merge attempt"
      pattern: "auto_resolve_known_conflicts"
    - from: "lib/commands/merge.sh"
      to: "lib/merge/rollback.sh"
      via: "save_rollback_point before merge, record_merged_branch after each"
      pattern: "save_rollback_point\\|record_merged_branch"
---

<objective>
Implement the core merge pipeline that iterates branches in plan order, performs dry-run preflight, merges with auto-resolution, skips conflicted branches, and produces a summary report with optional full diffs.

Purpose: This is the heart of `gsd-ralph merge N` -- the command that takes completed execution branches and merges them back into main with safety guarantees. Without this, users must manually merge branches after each phase execution.
Output: Working `gsd-ralph merge N` command that merges branches, handles conflicts gracefully, and shows review output.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output (modules this plan orchestrates)
@.planning/phases/04-merge-orchestration/04-01-SUMMARY.md

# Existing code to build on
@lib/commands/merge.sh
@lib/merge/dry_run.sh
@lib/merge/rollback.sh
@lib/merge/auto_resolve.sh
@lib/common.sh

# Reference implementation
@scripts/ralph-merge.sh

# Research
@.planning/phases/04-merge-orchestration/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement core merge pipeline in cmd_merge</name>
  <files>lib/commands/merge.sh</files>
  <action>
Replace the placeholder in `cmd_merge()` (the "Merge pipeline not yet implemented" message from Plan 04-01) with the full merge pipeline. The pipeline follows this sequence:

**Phase 1 -- Dry-run preflight (all branches before any merge):**
- Iterate all branches in `MERGE_BRANCHES` array
- Call `merge_dry_run "$branch"` for each
- Sort into two arrays: `clean_branches` and `conflict_branches`
- If `merge_dry_run` detects conflicts, call `merge_dry_run_conflicts "$branch"` to get file list for reporting
- Print dry-run report: table showing each branch and its status (clean / conflicts with file list)
- If --dry-run flag is set, print report and return 0 (do not merge)
- If ALL branches conflict, print warning and return 1

**Phase 2 -- Save rollback point:**
- Call `save_rollback_point "$phase_num"` (saves current HEAD before any merges)

**Phase 3 -- Merge clean branches sequentially:**
- Iterate `clean_branches` in plan order (they were added in plan order from MERGE_BRANCHES)
- For each branch:
  1. Capture `sha_before=$(git rev-parse HEAD)`
  2. Attempt `git merge --no-ff --no-edit "$branch"`
  3. If merge succeeds cleanly (exit 0):
     - Call `record_merged_branch "$branch" "$sha_before"`
     - Record in results array: `"$branch:merged:$(git diff --stat "$sha_before"..HEAD | tail -1):$(git rev-list --count "$sha_before"..HEAD)"`
  4. If merge fails (conflict):
     - Attempt auto-resolution: call `auto_resolve_known_conflicts`
     - If auto_resolve returns 0 (all resolved): treat as successful merge, record as "merged (auto-resolved)"
     - If auto_resolve returns 1 (remaining conflicts):
       - Capture conflicting files: `git diff --name-only --diff-filter=U`
       - Abort the merge: `git merge --abort`
       - Record in results: `"$branch:skipped:conflict in: $conflicted_files:0"`
       - Print warning with conflict guidance: list conflicting files and suggest manual resolution
       - Continue to next branch

**Phase 4 -- Store results for review:**
- Store the results array in a global `MERGE_RESULTS` for the review module to consume
- Store merge metadata: `MERGE_PHASE`, `MERGE_ROLLBACK_SHA`, `MERGE_BRANCH_COUNT`, `MERGE_SUCCESS_COUNT`, `MERGE_SKIP_COUNT`

**Important implementation notes:**
- Use indexed arrays only (no associative arrays -- Bash 3.2)
- Results array uses colon-delimited strings: "branch:status:details:commits"
- The conflict_branches array from dry-run should be reported but NOT attempted (they are known to conflict)
- Track both dry-run-detected conflicts and merge-time conflicts separately in the summary
- If a branch that passed dry-run fails during actual merge (rare race condition from Pitfall 2 in research), handle gracefully with auto-resolve attempt then skip
  </action>
  <verify>
`shellcheck lib/commands/merge.sh` passes.
In a test repo: create a branch with changes, switch to main, run `gsd-ralph merge N` -- branch is merged into main. Verify with `git log --oneline`.
  </verify>
  <done>
Core merge pipeline merges branches sequentially, auto-resolves known conflicts, skips truly conflicted branches, and tracks results for the summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create review module and conflict guidance, extend tests</name>
  <files>lib/merge/review.sh, lib/commands/merge.sh, tests/merge.bats</files>
  <action>
**lib/merge/review.sh:**
- `print_merge_summary()` -- takes the MERGE_RESULTS array (passed as arguments, colon-delimited strings). Prints a formatted table:
  ```
  Branch                    Status         Files    Commits
  ─────────────────────────────────────────────────────────
  phase-4/merge-orch        merged         12       3
  phase-4/another           skipped        -        -
  ```
  Use `printf` with fixed-width columns. Status values: "merged", "merged*" (auto-resolved), "skipped", "conflict" (dry-run detected).
  Below the table, print totals: "N merged, M skipped, K conflicts detected"
  If any branches were skipped, print a "Skipped branches" section listing each with its conflict files.

- `print_merge_review()` -- takes phase_num and the MERGE_RESULTS array. For each merged branch, shows `git diff --stat "$sha_before".."$sha_after"` and `git log --oneline "$sha_before".."$sha_after"`. Uses the sha_before/sha_after from the rollback file's branches_merged array (read via jq). This is the --review enhanced output.

- `print_conflict_guidance()` -- takes branch name and conflicting files (space-separated). Prints clear resolution guidance:
  ```
  [warn] Branch phase-4/merge-orch has conflicts in:
           - src/lib/foo.sh
           - src/lib/bar.sh

         To resolve manually:
           1. git merge phase-4/merge-orch
           2. Edit conflicted files (look for <<<<<<< markers)
           3. git add <resolved-files>
           4. git commit --no-edit
  ```

**Integrate review into lib/commands/merge.sh:**
- Source `lib/merge/review.sh`
- After Phase 3 (merge loop), call `print_merge_summary` with the results array
- If `--review` flag is set, also call `print_merge_review`
- For each skipped branch, call `print_conflict_guidance`

**tests/merge.bats (extend with new tests):**
- "merge merges a clean branch into main" -- create branch with non-conflicting change, run `gsd-ralph merge`, verify branch changes are in main (`git log --oneline` shows merge commit)
- "merge produces summary table" -- run merge, assert output contains "merged" and the branch name in a table-like format
- "merge skips conflicted branch and continues" -- create two branches: one clean, one conflicting. Run merge. Verify clean branch is merged, conflicting branch is skipped, output shows both statuses.
- "merge with --dry-run shows report without merging" -- create a branch, run with --dry-run, assert branch is NOT merged (git log doesn't show merge), but output shows "clean" status
- "merge with --review shows detailed diffs" -- merge a branch, run with --review (re-run merge after setup -- or check that review output appears during merge). Assert output contains diff stats.
- "merge auto-resolves .planning/ conflicts" -- create branch that modifies .planning/STATE.md differently from main. Run merge. Assert merge succeeds (auto-resolved) and summary shows "merged*" or similar.
- "merge reports conflict guidance for skipped branches" -- create conflicting branch, run merge. Assert output contains "To resolve manually" and lists conflicting files.
  </action>
  <verify>
`shellcheck lib/merge/review.sh lib/commands/merge.sh` passes.
`bats tests/merge.bats` -- all tests pass (both new and existing from Plan 04-01).
Run `gsd-ralph merge N` in a test repo with a merge branch: see summary table output.
Run `gsd-ralph merge N --review`: see detailed diff output in addition to summary.
  </verify>
  <done>
Merge command produces a clear post-merge summary table showing branch status, file count, and commit count. Conflicted branches get clear resolution guidance. --review flag shows full diff details. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `gsd-ralph merge N` merges all clean branches and skips conflicted ones
2. Summary table is printed after every merge operation
3. `gsd-ralph merge N --review` shows additional diff/log details per merged branch
4. `gsd-ralph merge N --dry-run` reports without merging
5. .planning/ conflicts are auto-resolved
6. Conflict guidance lists specific conflicting files with manual resolution steps
7. All tests pass: `bats tests/merge.bats`
8. No regressions: `bats tests/` (all project tests pass)
</verification>

<success_criteria>
- `gsd-ralph merge N` successfully merges completed branches into main
- Conflicted branches are skipped with clear guidance, not fatal errors
- Post-merge summary table shows actionable status for every branch
- --review mode provides detailed diffs without requiring separate git commands
- --dry-run mode is safe and informative
</success_criteria>

<output>
After completion, create `.planning/phases/04-merge-orchestration/04-02-SUMMARY.md`
</output>

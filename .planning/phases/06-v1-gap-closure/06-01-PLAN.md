---
phase: 06-v1-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/common.sh
  - lib/commands/execute.sh
  - lib/commands/merge.sh
  - tests/execute.bats
  - tests/merge.bats
autonomous: true
requirements:
  - EXEC-06
gap_closure: true

must_haves:
  truths:
    - "Terminal bell fires when execute command completes successfully (after 'Run ralph to start execution')"
    - "Terminal bell fires when execute command fails after significant work (branch already created)"
    - "Terminal bell fires when merge command completes successfully (all branches merged, tests pass)"
    - "Terminal bell fires when merge command completes with failures (skipped branches, conflicts, or test regressions)"
    - "Terminal bell does NOT fire on trivial validation errors (missing args, not in git repo)"
  artifacts:
    - path: "lib/common.sh"
      provides: "ring_bell() function that emits terminal bell character"
      contains: "ring_bell"
    - path: "lib/commands/execute.sh"
      provides: "Bell call on execute success"
      contains: "ring_bell"
    - path: "lib/commands/merge.sh"
      provides: "Bell calls on merge success and failure"
      contains: "ring_bell"
    - path: "tests/execute.bats"
      provides: "Test verifying bell character in execute output"
      contains: "ring_bell\\|\\\\a"
    - path: "tests/merge.bats"
      provides: "Test verifying bell character in merge output"
      contains: "ring_bell\\|\\\\a"
  key_links:
    - from: "lib/commands/execute.sh"
      to: "lib/common.sh"
      via: "ring_bell() call at end of cmd_execute (success) and EXIT trap after branch creation (failure)"
      pattern: "ring_bell"
    - from: "lib/commands/merge.sh"
      to: "lib/common.sh"
      via: "ring_bell() calls before return 0 and return 1"
      pattern: "ring_bell"
---

<objective>
Implement the terminal bell notification (EXEC-06) by adding a `ring_bell()` function to `lib/common.sh` and calling it at the four key exit points in `execute.sh` and `merge.sh`.

Purpose: Long-running execute and merge operations should audibly notify the user on completion or failure, so they can context-switch away during execution and be alerted when attention is needed.

Output: `ring_bell()` function in `lib/common.sh`, bell calls in `execute.sh` (success + failure after branch creation) and `merge.sh` (success + failure), and tests verifying the bell character appears in output.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/common.sh
@lib/commands/execute.sh
@lib/commands/merge.sh
@tests/execute.bats
@tests/merge.bats
@.planning/phases/06-v1-gap-closure/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ring_bell function and integrate into execute and merge commands</name>
  <files>lib/common.sh, lib/commands/execute.sh, lib/commands/merge.sh</files>
  <action>
**1. Add `ring_bell()` to `lib/common.sh`:**

Add the following function after the `die()` function (after line 43):

```bash
# Ring the terminal bell to notify the user of command completion.
# Called after long-running operations (execute, merge) succeed or fail.
# Not called on trivial validation errors (missing args, wrong directory).
ring_bell() {
    printf '\a'
}
```

This uses `printf '\a'` which is POSIX-standard and works on macOS Bash 3.2 (verified in research). Do NOT add bell to the `die()` function itself -- that would ring on trivial validation errors.

**2. Add bell to `lib/commands/execute.sh`:**

Add `ring_bell` calls at two points in `cmd_execute()`:

**Success bell (line 242):** After the `print_success "Run 'ralph' to start execution"` line, add `ring_bell`. This fires on successful completion.

**Failure bell (after branch creation):** All `die` calls and `exit 1` points in `cmd_execute()` occur before branch creation (line 156), so there are no current failure exit points after significant work. However, the post-branch-creation steps (generate PROMPT.md, generate fix_plan.md, init execution log, update STATE.md, git commit) can fail silently or via uncaught errors. To ensure the bell fires on failure after branch creation, wrap Steps 7-11 (lines 163-225) in an error-handling pattern: create a helper function `_execute_post_branch_setup()` containing the existing Steps 7-11 code, and call it with a trap in cmd_execute so that if any step fails, `ring_bell` fires before exit. Specifically:

After the branch creation block (after line 161 `print_verbose "Registered branch in worktree registry"`), add:

```bash
    # Ensure bell rings if any post-branch step fails (user has done significant work)
    trap 'ring_bell' EXIT
```

Then at the very end of the function (after `ring_bell` on the success path), clear the trap so it does not double-ring:

```bash
    # Step 13: Print launch instructions
    printf "\n"
    print_success "Run 'ralph' to start execution"
    ring_bell
    trap - EXIT
}
```

This ensures: (a) on success, `ring_bell` fires explicitly and the trap is cleared, (b) on any failure after branch creation (e.g., generate function fails, git commit fails), the EXIT trap fires `ring_bell` before the shell exits. The trap is set AFTER branch creation so trivial validation errors before branch creation do NOT trigger the bell.

Do NOT add bell to validation failures (missing phase number, not in git repo, etc.) because those are instantaneous and the user is already watching.

**3. Add bell to `lib/commands/merge.sh`:**

Add `ring_bell` calls at both exit points of `cmd_merge()` -- before `return 1` (failure) and before `return 0` (success) at the end of the function. These are currently at lines 416-419.

The end of `cmd_merge()` should look like:

```bash
    # Return non-zero if any branches were skipped, had dry-run conflicts, or tests failed
    local conflict_branch_count=${#conflict_branches[@]}
    if [[ $skip_count -gt 0 ]] || [[ $conflict_branch_count -gt 0 ]] || [[ "$test_failed" == true ]]; then
        ring_bell
        return 1
    fi
    ring_bell
    return 0
}
```

Do NOT add bell to the early returns in `cmd_merge()` (--rollback, no branches found, dry-run mode) -- those are either fast operations or explicitly non-modifying.
  </action>
  <verify>
1. Source the files to verify no syntax errors:
```bash
source lib/common.sh && type ring_bell
```
2. Run ShellCheck on all three files:
```bash
make lint
```
3. Verify `ring_bell` is called in both execute.sh and merge.sh:
```bash
grep -n 'ring_bell' lib/commands/execute.sh lib/commands/merge.sh lib/common.sh
```
  </verify>
  <done>
`ring_bell()` function exists in `lib/common.sh`. Execute command calls `ring_bell` after successful setup AND fires `ring_bell` via EXIT trap if any post-branch-creation step fails. Merge command calls `ring_bell` before both `return 0` (success) and `return 1` (failure with skipped/conflict/regression). No bell on trivial validation errors (before branch creation). ShellCheck passes clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add terminal bell tests to execute and merge test suites</name>
  <files>tests/execute.bats, tests/merge.bats</files>
  <action>
**1. Add bell test to `tests/execute.bats`:**

Add a new test case at the end of the file that verifies the BEL character (ASCII 0x07) appears in execute output on success. Since bats captures stdout, and `printf '\a'` writes to stdout, the BEL character will be in `$output`.

```bash
@test "execute rings terminal bell on completion" {
    _setup_execute_test_repo
    run gsd-ralph execute 5
    assert_success
    # BEL character (ASCII 0x07) should be in output from ring_bell
    [[ "$output" == *$'\a'* ]]
}
```

Place this test after the existing execute tests. Use the same `_setup_execute_test_repo` helper already used by the other execute tests (examine the existing setup pattern in the file -- it creates a test repo with `.planning/phases/`, `.ralph/`, and plan files).

**2. Add bell test to `tests/merge.bats`:**

Add a new test case at the end of the file that verifies the BEL character appears in merge output on success. Use the existing merge test setup helper that creates a test repo with a merge-ready branch.

```bash
@test "merge rings terminal bell on completion" {
    _setup_merge_test_repo
    run gsd-ralph merge 5
    assert_success
    # BEL character (ASCII 0x07) should be in output from ring_bell
    [[ "$output" == *$'\a'* ]]
}
```

Examine the existing merge test setup pattern -- tests create a repo on `main` with `.planning/phases/`, `.ralph/`, create a branch with commits, then switch back to main before running merge.

**3. Also add a test verifying ring_bell function exists and works in common tests (if a common.bats exists) or in execute.bats:**

```bash
@test "ring_bell function exists" {
    run ring_bell
    assert_success
}
```

Add this to whichever test file already loads `common.sh` in its setup.

Run `make test` to confirm all tests pass, including existing tests (no regressions).
  </action>
  <verify>
```bash
make test
```
All tests pass, including the new bell tests. No regressions in existing test suites.
  </verify>
  <done>
Terminal bell tests exist in execute.bats and merge.bats. Tests verify the BEL character (ASCII 0x07) appears in command output. All existing tests still pass (no regressions). `make test` is fully green.
  </done>
</task>

</tasks>

<verification>
1. `grep -n 'ring_bell' lib/common.sh lib/commands/execute.sh lib/commands/merge.sh` shows function definition and 4+ call sites (execute: success + EXIT trap, merge: success + failure)
2. `make lint` passes (ShellCheck clean on all modified files)
3. `make test` passes (all tests including new bell tests, no regressions)
4. `printf '\a'` is the bell mechanism (POSIX-standard, Bash 3.2 compatible)
5. Bell does NOT fire on: `gsd-ralph execute` (no args), `gsd-ralph merge` (no args), `gsd-ralph merge N --dry-run`, `gsd-ralph merge N --rollback`
6. Bell DOES fire on: successful execute, failed execute after branch creation, successful merge, failed merge (skipped/conflict/regression)
</verification>

<success_criteria>
- `ring_bell()` function exists in `lib/common.sh` using `printf '\a'`
- Execute command rings bell on successful completion and on failure after branch creation (EXIT trap)
- Merge command rings bell on both success and failure (after substantial work)
- No bell on trivial validation errors or dry-run mode
- All tests pass including new bell-specific tests
- No regressions in existing test suites
- ShellCheck passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-v1-gap-closure/06-01-SUMMARY.md`
</output>

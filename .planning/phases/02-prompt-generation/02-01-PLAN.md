---
phase: 02-prompt-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/discovery.sh
  - templates/PROMPT.md.template
  - templates/AGENT.md.template
  - tests/discovery.bats
  - tests/test_helper/fixtures/single-plan/PLAN.md
  - tests/test_helper/fixtures/multi-plan/02-01-PLAN.md
  - tests/test_helper/fixtures/multi-plan/02-02-PLAN.md
  - tests/test_helper/fixtures/multi-plan/02-03-PLAN.md
  - tests/test_helper/fixtures/edge-cases/empty-plan.md
autonomous: true

must_haves:
  truths:
    - "find_phase_dir locates a phase directory by number using the GSD NN-slug format"
    - "discover_plan_files finds NN-MM-PLAN.md files in a phase directory and falls back to PLAN.md for single-plan phases"
    - "plan_id_from_filename extracts the plan ID (e.g., '01') from both NN-MM-PLAN.md and bare PLAN.md filenames"
    - "worktree_path_for_plan computes the correct worktree path in the format parent/repo-pN-NN"
    - "PROMPT.md template is parameterized with {{VARIABLE}} placeholders instead of hardcoded bayesian-it content"
    - "AGENT.md template is parameterized with {{VARIABLE}} placeholders instead of hardcoded bayesian-it content"
    - "Discovery tests pass with fixture plan files covering single-plan, multi-plan, and edge cases"
  artifacts:
    - path: "lib/discovery.sh"
      provides: "GSD plan file discovery and naming convention handling"
      contains: "find_phase_dir"
      min_lines: 60
    - path: "templates/PROMPT.md.template"
      provides: "Parameterized PROMPT.md base template"
      contains: "{{PROJECT_NAME}}"
    - path: "templates/AGENT.md.template"
      provides: "Parameterized AGENT.md template"
      contains: "{{TEST_CMD}}"
    - path: "tests/discovery.bats"
      provides: "Unit tests for discovery module"
      min_lines: 60
  key_links:
    - from: "lib/discovery.sh"
      to: "lib/common.sh"
      via: "print_error, print_verbose calls"
      pattern: "print_error\\|print_verbose"
    - from: "tests/discovery.bats"
      to: "lib/discovery.sh"
      via: "source and function calls"
      pattern: "source.*discovery\\.sh"
---

<objective>
Create the plan discovery module and parameterized templates that form the foundation for Phase 2's file generation pipeline. By the end, gsd-ralph can locate plan files using both GSD naming conventions, and the templates are ready for per-worktree rendering.

Purpose: Establish the foundational library (`lib/discovery.sh`) and parameterized templates (`PROMPT.md.template`, `AGENT.md.template`) that the generation pipeline (Plan 02-02) will consume. Covers requirement EXEC-07 (dual naming conventions) and prepares artifacts for EXEC-02 (PROMPT.md generation) and EXEC-04 (.ralphrc generation).
Output: Working discovery module with unit tests, parameterized templates, test fixtures.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-prompt-generation/02-RESEARCH.md
@.planning/phases/01-project-initialization/01-02-SUMMARY.md
@lib/common.sh
@lib/templates.sh
@scripts/ralph-worktrees.sh
@templates/PROMPT.md.template
@templates/AGENT.md.template
@tests/test_helper/common.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/discovery.sh with plan discovery functions and test fixtures</name>
  <files>lib/discovery.sh, tests/discovery.bats, tests/test_helper/fixtures/single-plan/PLAN.md, tests/test_helper/fixtures/multi-plan/02-01-PLAN.md, tests/test_helper/fixtures/multi-plan/02-02-PLAN.md, tests/test_helper/fixtures/multi-plan/02-03-PLAN.md, tests/test_helper/fixtures/edge-cases/empty-plan.md</files>
  <action>
Create `lib/discovery.sh` implementing four functions for GSD plan file discovery. Follow the patterns from `lib/common.sh` (local variables, bash 3.2 compat, ShellCheck clean).

**Functions to implement:**

1. **find_phase_dir(phase_num, [planning_base])** -- Locate a phase directory by number.
   - Zero-pad `phase_num` to 2 digits via `printf "%02d"`
   - Look for `${base}/${padded}-*` directories (GSD format: NN-slug)
   - Use `ls -d` piped to `head -1` for first match (deterministic ordering)
   - Set global `PHASE_DIR` to the found path
   - Return 0 if found, 1 if not found
   - Default `base` to `.planning/phases`

2. **discover_plan_files(phase_dir)** -- Find plan files in a phase directory.
   - Use precise glob `[0-9][0-9]-[0-9][0-9]-PLAN.md` for numbered plans (avoids matching non-plan files like RESEARCH-PLAN.md)
   - Iterate with `for f in "$phase_dir"/[0-9][0-9]-[0-9][0-9]-PLAN.md; do` pattern
   - Skip non-file matches (`[[ -f "$f" ]] || continue`)
   - Fallback: if no numbered plans found, check for `$phase_dir/PLAN.md`
   - Set global `PLAN_FILES` array and `PLAN_COUNT` integer
   - Return 0 if plans found, 1 if none

3. **plan_id_from_filename(plan_filename)** -- Extract plan ID from filename.
   - For `NN-MM-PLAN.md` format: extract the MM portion using `BASH_REMATCH` with pattern `^[0-9][0-9]-([0-9][0-9])-PLAN\.md$`
   - For bare `PLAN.md`: return "01" (single-plan default)
   - Operate on basename (call `basename` on input to handle full paths)

4. **worktree_path_for_plan(parent_dir, repo_name, phase_num, plan_id)** -- Compute worktree path.
   - Format: `${parent_dir}/${repo_name}-p${phase_num}-${plan_id}`
   - Echo the result to stdout

**Header:** Add `#!/bin/bash` and `# lib/discovery.sh -- GSD plan file discovery and naming convention handling` at top.

**Test fixtures:** Create minimal fixture files for testing:

- `tests/test_helper/fixtures/single-plan/PLAN.md`: Minimal plan with one `<task>` block containing `<name>Task 1: Single plan task</name>`.
- `tests/test_helper/fixtures/multi-plan/02-01-PLAN.md`: Minimal plan with two `<task>` blocks.
- `tests/test_helper/fixtures/multi-plan/02-02-PLAN.md`: Minimal plan with one `<task>` block.
- `tests/test_helper/fixtures/multi-plan/02-03-PLAN.md`: Minimal plan with one `<task>` block.
- `tests/test_helper/fixtures/edge-cases/empty-plan.md`: Plan file with frontmatter but no `<task>` blocks.

Each fixture needs valid GSD frontmatter (`---` delimited YAML with phase, plan, type, wave fields) and `<tasks>...</tasks>` section wrapping `<task>` blocks. Include `<name>`, `<action>`, `<verify>`, `<done>` in each task to match real GSD format.

**Unit tests (tests/discovery.bats):** Write tests covering:

1. "find_phase_dir finds phase by number" -- Create `$TEST_TEMP_DIR/.planning/phases/02-prompt-generation/`, call find_phase_dir 2 with base, assert PHASE_DIR is set correctly
2. "find_phase_dir returns 1 for missing phase" -- Call with nonexistent phase number, assert return code 1, assert PHASE_DIR is empty
3. "find_phase_dir zero-pads single digit" -- Create `$TEST_TEMP_DIR/.planning/phases/03-test/`, call with 3 (not 03), assert found
4. "discover_plan_files finds numbered plans" -- Copy multi-plan fixtures into temp dir, call discover_plan_files, assert PLAN_COUNT is 3, assert PLAN_FILES array has 3 entries
5. "discover_plan_files falls back to PLAN.md" -- Copy single-plan fixture, call discover_plan_files, assert PLAN_COUNT is 1, assert PLAN_FILES contains PLAN.md
6. "discover_plan_files returns 1 for empty directory" -- Call on empty dir, assert return code 1, assert PLAN_COUNT is 0
7. "discover_plan_files ignores non-plan files" -- Create a file named `RESEARCH-PLAN.md` alongside PLAN.md, ensure only PLAN.md is found (not RESEARCH-PLAN.md, since it does not match the `[0-9][0-9]-[0-9][0-9]-PLAN.md` pattern and PLAN.md fallback wins)
8. "plan_id_from_filename extracts ID from numbered plan" -- Call with "02-01-PLAN.md", assert output "01"
9. "plan_id_from_filename handles bare PLAN.md" -- Call with "PLAN.md", assert output "01"
10. "plan_id_from_filename extracts from full path" -- Call with "/some/path/03-02-PLAN.md", assert output "02"
11. "worktree_path_for_plan computes correct path" -- Call with known args, assert output matches format
12. "discover_plan_files returns plans in sorted order" -- Create plans 02-03, 02-01, 02-02 (out of order), verify PLAN_FILES are returned sorted

**Test setup:** Each test sources lib/common.sh and lib/discovery.sh (use `source "$PROJECT_ROOT/lib/common.sh"` and `source "$PROJECT_ROOT/lib/discovery.sh"` in setup). Use `_common_setup` from test_helper/common.bash for temp directory creation.
  </action>
  <verify>
Run `shellcheck -s bash lib/discovery.sh` -- no errors or warnings.
Run `make test` -- all tests pass including new discovery.bats.
Run `grep -c '@test' tests/discovery.bats` -- at least 10 test cases.
  </verify>
  <done>
lib/discovery.sh has 4 functions (find_phase_dir, discover_plan_files, plan_id_from_filename, worktree_path_for_plan) that handle GSD's dual naming convention. 10+ unit tests pass in discovery.bats. ShellCheck clean. No bash 4+ features. Test fixtures created for single-plan, multi-plan, and edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Parameterize PROMPT.md.template and AGENT.md.template</name>
  <files>templates/PROMPT.md.template, templates/AGENT.md.template</files>
  <action>
Rewrite `templates/PROMPT.md.template` from its current hardcoded bayesian-it content to a fully parameterized template. Also rewrite `templates/AGENT.md.template`.

**PROMPT.md.template rewrite:**

The template serves as the base content for Ralph's PROMPT.md. It will be rendered via `render_template` with {{VARIABLE}} substitution, then dynamic sections (scope lock, peer visibility, merge order) will be appended by `lib/prompt.sh` (Plan 02-02).

Variables to use:
- `{{PROJECT_NAME}}` -- project name (from git root basename)
- `{{PROJECT_LANG}}` -- detected language (from detect_project_type)
- `{{TEST_CMD}}` -- detected test command (may be empty)
- `{{BUILD_CMD}}` -- detected build command (may be empty)

Template structure (adapt from current template but replace all hardcoded values):

1. **Title:** `# Ralph Development Instructions -- {{PROJECT_NAME}}`
2. **Context section:** Generic project description using `{{PROJECT_NAME}}`. Mention GSD workflow. Keep it project-agnostic.
3. **How to Find Your Work section:** Keep the task discovery sequence as-is (it is already generic). This explains how Ralph navigates GSD plans.
4. **GSD Task Format section:** Keep the XML task format documentation as-is (it is generic GSD format).
5. **Required Reading section:** Keep the list of files to read (STATE.md, PROJECT.md, ROADMAP.md, plan file). Generic.
6. **Execution Rules section:** Replace hardcoded `npm test` with `{{TEST_CMD}}` and `npm run typecheck` with `{{BUILD_CMD}}`. Replace "TypeScript" references with `{{PROJECT_LANG}}`. Keep the numbered rules structure. If TEST_CMD or BUILD_CMD is empty, the template should still be valid (the executor handles empty commands gracefully).
7. **Dependency Checking section:** Keep as-is (generic).
8. **Blocked State section:** Keep as-is (generic).
9. **Key Principles section:** Keep as-is (generic).
10. **Project Stack section:** Use `{{PROJECT_LANG}}` for language, `{{TEST_CMD}}` for testing, `{{BUILD_CMD}}` for build. Remove all hardcoded TypeScript/Vitest/tsc/better-sqlite3/Zod references.
11. **Status Reporting section:** Keep the `---RALPH_STATUS---` block format as-is (generic Ralph protocol). Replace `npm test` and `npm run typecheck` with `{{TEST_CMD}}` and `{{BUILD_CMD}}` in the EXIT_SIGNAL conditions.
12. **Current Task section:** Keep as-is (generic instruction to read STATE.md).

**Remove from template:** File Structure section (this is project-specific and will be populated by the project's own docs or omitted). Remove any bayesian-it references, Node.js/TypeScript specifics, Vitest mentions, Zod mentions, better-sqlite3 mentions.

**Do NOT include in template** (these are appended dynamically by prompt.sh):
- Scope lock section
- Peer visibility section
- Merge order section

**AGENT.md.template rewrite:**

Variables:
- `{{PROJECT_NAME}}` -- project name
- `{{PROJECT_LANG}}` -- detected language
- `{{TEST_CMD}}` -- test command
- `{{BUILD_CMD}}` -- build command

Template structure:
1. Title: `# Agent Build Instructions -- {{PROJECT_NAME}}`
2. Build section: Use `{{BUILD_CMD}}` (or note "No build command configured" pattern)
3. Running Tests section: Use `{{TEST_CMD}}`
4. Keep it minimal -- just build/test commands and a note about project language
5. Remove all bayesian-it references, TypeScript specifics, Vitest specifics

**Validation after rewrite:**
- Grep both templates for "bayesian", "npm", "TypeScript", "Vitest", "tsc", "Zod", "better-sqlite3", "NodeNext" -- no matches should exist
- Grep both templates for "{{PROJECT_NAME}}", "{{TEST_CMD}}", "{{BUILD_CMD}}" -- matches should exist
- Templates should be valid Markdown when all {{}} are replaced with sample values
  </action>
  <verify>
Run `grep -i 'bayesian\|vitest\|better-sqlite\|zod\|nodenext' templates/PROMPT.md.template templates/AGENT.md.template` -- should return no matches.
Run `grep -c '{{' templates/PROMPT.md.template` -- should show placeholder count (at least 4).
Run `grep -c '{{' templates/AGENT.md.template` -- should show placeholder count (at least 3).
Verify templates render correctly by eyeball check: conceptually substitute {{PROJECT_NAME}}=myproject, {{PROJECT_LANG}}=rust, {{TEST_CMD}}="cargo test", {{BUILD_CMD}}="cargo build" and verify the result reads naturally.
Run `make check` -- ShellCheck and all existing tests still pass (template changes do not break init tests since init uses ralphrc.template, not these).
  </verify>
  <done>
PROMPT.md.template and AGENT.md.template are fully parameterized with {{VARIABLE}} placeholders. No hardcoded project-specific content remains. Both templates work for any project stack (Node, Rust, Go, Python, etc.). No bayesian-it references. make check passes.
  </done>
</task>

</tasks>

<verification>
1. `shellcheck -s bash lib/discovery.sh` passes
2. `make check` passes (lint + all tests, including new discovery.bats)
3. `grep -c '@test' tests/discovery.bats` >= 10
4. `grep -i 'bayesian' templates/PROMPT.md.template templates/AGENT.md.template` returns no matches
5. Templates contain {{PROJECT_NAME}}, {{PROJECT_LANG}}, {{TEST_CMD}}, {{BUILD_CMD}} placeholders
6. Test fixtures exist in tests/test_helper/fixtures/ for single-plan, multi-plan, and edge cases
7. No bash 4+ features in any new code
</verification>

<success_criteria>
- EXEC-07: discover_plan_files handles both PLAN.md and NN-MM-PLAN.md -- VERIFIED by discovery.bats tests 4, 5, 7
- Template foundation for EXEC-02: PROMPT.md.template is parameterized and ready for per-worktree rendering
- Template foundation for EXEC-04: AGENT.md.template is parameterized (ralphrc.template already parameterized from Phase 1)
- All existing tests continue to pass (no regressions)
- ShellCheck clean on all new code
</success_criteria>

<output>
After completion, create `.planning/phases/02-prompt-generation/02-01-SUMMARY.md`
</output>

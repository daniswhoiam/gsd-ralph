---
phase: 05-cleanup
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - lib/commands/cleanup.sh
  - tests/cleanup.bats
autonomous: true
requirements:
  - CLEN-01
  - CLEN-02

must_haves:
  truths:
    - "User can run 'gsd-ralph cleanup N' and all registered worktrees and branches for phase N are removed"
    - "Cleanup only removes worktrees and branches tracked in the registry, not unrelated ones"
    - "Cleanup shows a preview and asks for confirmation before removing anything (unless --force)"
    - "Cleanup handles already-removed worktrees and branches gracefully without errors"
    - "After cleanup, git worktree prune runs and signal/rollback files for the phase are removed"
    - "Cleanup deregisters the phase from the worktree registry after successful removal"
  artifacts:
    - path: "lib/commands/cleanup.sh"
      provides: "Cleanup command with registry-driven removal, confirmation, force mode, summary"
      exports: ["cmd_cleanup"]
    - path: "tests/cleanup.bats"
      provides: "Integration tests for cleanup command and registry interaction"
      min_lines: 80
  key_links:
    - from: "lib/commands/cleanup.sh"
      to: "lib/cleanup/registry.sh"
      via: "source and function calls (list_registered_worktrees, deregister_phase)"
      pattern: "list_registered_worktrees|deregister_phase"
    - from: "lib/commands/cleanup.sh"
      to: ".ralph/worktree-registry.json"
      via: "registry module reads/writes"
      pattern: "WORKTREE_REGISTRY"
    - from: "lib/commands/cleanup.sh"
      to: "git worktree remove"
      via: "git commands for worktree and branch removal"
      pattern: "git worktree remove|git branch -[dD]"
    - from: "tests/cleanup.bats"
      to: "lib/commands/cleanup.sh"
      via: "bats test execution of gsd-ralph cleanup"
      pattern: "gsd-ralph cleanup"
---

<objective>
Implement the `gsd-ralph cleanup N` command that reads the worktree registry, removes all tracked worktrees and branches for a phase, cleans up signal/rollback files, and prints a summary.

Purpose: This completes the gsd-ralph lifecycle. After execute and merge, cleanup removes all phase artifacts so the user has a clean repository. The registry-driven approach (CLEN-02) ensures only gsd-ralph-created resources are removed.

Output: `lib/commands/cleanup.sh` fully implemented, `tests/cleanup.bats` with integration tests covering the happy path, force mode, already-removed resources, empty registry, and non-interactive mode.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/commands/merge.sh
@lib/merge/signals.sh
@lib/merge/rollback.sh
@lib/cleanup/registry.sh
@lib/common.sh
@scripts/ralph-cleanup.sh
@tests/test_helper/common.bash
@tests/merge.bats
@.planning/phases/05-cleanup/05-RESEARCH.md
@.planning/phases/05-cleanup/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cleanup command</name>
  <files>lib/commands/cleanup.sh</files>
  <action>
Replace the stub `cmd_cleanup()` in `lib/commands/cleanup.sh` with a full implementation. Follow the merge command's structure (argument parsing, environment validation, operation, summary).

**Source dependencies at the top of the file:**
```bash
source "$GSD_RALPH_HOME/lib/cleanup/registry.sh"
```

**cleanup_usage()**: Print help text following the pattern in `merge_usage()` (lib/commands/merge.sh lines 29-51). Document options: `--force` (skip confirmation and force-delete unmerged branches), `-v/--verbose`, `-h/--help`.

**cmd_cleanup(phase_num)**:

1. **Parse arguments**: Support `--force`, `-v/--verbose`, `-h/--help`, positional phase_num. Match the pattern in `cmd_merge()` (lines 113-143).

2. **Validate environment**: Check git repo, `.planning/` exists, `.ralph/` exists. Same 3 checks as `cmd_merge()` lines 146-154.

3. **Read registry**: Call `list_registered_worktrees "$phase_num"`. Parse the JSON array output using jq. Count entries with `jq '. | length'`. If count is 0:
   - Check if branches matching `phase-${phase_num}/*` exist in git (using `git for-each-ref --format='%(refname:short)' "refs/heads/phase-${phase_num}/"` plus the sequential branch check from `discover_merge_branches()`).
   - If unregistered branches exist, print a helpful message: "No tracked worktrees for phase N. Unregistered branches exist (run before registry was active). Use --force to clean these up." Then if `--force`, proceed to delete those branches. Otherwise, exit 0.
   - If no branches at all, print "Nothing to clean for phase N." and exit 0.

4. **Preview**: Print what will be removed. For each registered entry, print the worktree path (basename) and branch name. Use `print_info` for each line.

5. **Confirmation**: Unless `--force`, prompt for confirmation using the Bash 3.2 compatible pattern:
```bash
printf "Confirm removal? [y/N]: "
read -r confirm
```
If stdin is not a terminal (`! [[ -t 0 ]]`) and `--force` is not set, die with "Non-interactive mode requires --force flag."
If user does not confirm (not "y" or "Y"), print "Aborted." and return 0.

6. **Remove worktrees and branches** (iterate registry entries):
For each entry (use jq to extract `.worktree_path` and `.branch` by index):
   a. **Remove worktree**: If the directory exists (`[[ -d "$worktree_path" ]]`), run `git worktree remove --force "$worktree_path" 2>/dev/null`. If that fails, fall back to `rm -rf "$worktree_path" 2>/dev/null || true`. Print success or verbose skip.
   b. **Delete branch**: If branch exists (`git show-ref --verify --quiet "refs/heads/$branch_name"`), try `git branch -d "$branch_name" 2>/dev/null`. If that fails (unmerged) and `--force` is true, use `git branch -D "$branch_name" 2>/dev/null`. If not force, print warning with guidance. Track success/failure counts.
   c. If worktree/branch already removed, print verbose message (not error).

7. **Prune stale worktree references**: `git worktree prune`

8. **Clean up signal files**: `rm -f .ralph/merge-signals/phase-${phase_num}-*`

9. **Clean up rollback file**: If `.ralph/merge-rollback.json` exists and its `.phase` field matches `$phase_num` (checked via jq), remove it.

10. **Deregister phase from registry**: Call `deregister_phase "$phase_num"`.

11. **Print summary**: Use `print_header "Cleanup Summary"` and print counts of worktrees removed, branches deleted, branches skipped (unmerged). Match the output style of merge.sh's summary section.

**Error handling**: Each removal step should be independently fault-tolerant. A failure to remove one worktree should not prevent removal of others. Track and report all failures in the summary.
  </action>
  <verify>
Source the file without errors:
```bash
source lib/common.sh && source lib/cleanup/registry.sh && source lib/commands/cleanup.sh && type cmd_cleanup cleanup_usage
```
Run `gsd-ralph cleanup --help` to confirm help text is printed.
  </verify>
  <done>
lib/commands/cleanup.sh implements the full cleanup pipeline: argument parsing, registry reading, preview, confirmation, worktree removal, branch deletion, pruning, signal/rollback cleanup, deregistration, and summary. Handles already-removed resources, unregistered branches (migration gap), non-interactive mode, and --force flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cleanup integration tests</name>
  <files>tests/cleanup.bats</files>
  <action>
Create `tests/cleanup.bats` following the patterns in `tests/merge.bats` (setup/teardown, test repo helpers, assertion patterns).

**Setup/teardown**: Use `_common_setup`/`_common_teardown` from `tests/test_helper/common.bash`. Each test creates an isolated temp directory with a git repo.

**Helper functions**:
- `setup_cleanup_test_repo()`: Creates a test repo, `.planning/phases/05-test-phase/`, `.ralph/` directory, and registers a branch in the worktree registry by sourcing `registry.sh` and calling `register_worktree`.
- `create_test_branch(branch_name)`: Creates a branch with a commit, then switches back to main.

**Test cases** (aim for 10-15 tests):

1. **cleanup --help shows usage**: Run `gsd-ralph cleanup --help`, assert output contains "Usage" and "cleanup".

2. **cleanup requires phase number**: Run `gsd-ralph cleanup` (no args), assert failure and "Phase number required" in output.

3. **cleanup with empty registry shows nothing to clean**: Set up repo with empty registry, run `gsd-ralph cleanup 5 --force`, assert "Nothing to clean" message.

4. **cleanup removes registered branch**: Register a branch, create it in git, run `gsd-ralph cleanup 5 --force`. Assert branch no longer exists (`git show-ref --verify --quiet refs/heads/$branch_name` returns 1). Assert registry no longer has phase 5 entries.

5. **cleanup removes multiple registered entries**: Register 2 branches for the same phase. Create both. Run `gsd-ralph cleanup 5 --force`. Assert both branches deleted and phase deregistered.

6. **cleanup handles already-deleted branch gracefully**: Register a branch, but do NOT create it in git. Run `gsd-ralph cleanup 5 --force`. Assert succeeds (exit 0) without errors.

7. **cleanup handles already-removed worktree gracefully**: Register a worktree path that does not exist. Run `gsd-ralph cleanup 5 --force`. Assert succeeds.

8. **cleanup refuses without --force in non-interactive mode**: Pipe input (non-terminal). Run `echo "" | gsd-ralph cleanup 5`. Assert failure and "Non-interactive" or "--force" in output.

9. **cleanup with --force skips confirmation**: Set up registered branch, run `gsd-ralph cleanup 5 --force`. Assert succeeds without prompting.

10. **cleanup removes signal files**: Create `.ralph/merge-signals/phase-5-wave-1-complete` and `.ralph/merge-signals/phase-5-complete`. Run `gsd-ralph cleanup 5 --force`. Assert signal files removed.

11. **cleanup removes rollback file for matching phase**: Create `.ralph/merge-rollback.json` with `{"phase": 5, "pre_merge_sha": "abc123"}`. Run `gsd-ralph cleanup 5 --force`. Assert file removed.

12. **cleanup preserves rollback file for different phase**: Create `.ralph/merge-rollback.json` with `{"phase": 3, "pre_merge_sha": "abc123"}`. Run `gsd-ralph cleanup 5 --force`. Assert file still exists.

13. **cleanup runs git worktree prune**: Run cleanup, then `git worktree list`. Assert no stale entries. (This is hard to test directly, but verify the command completes without error.)

14. **cleanup preserves other phases in registry**: Register branches for phase 5 and phase 3. Run `gsd-ralph cleanup 5 --force`. Assert phase 3 entries still in registry.

Use `assert_success`, `assert_failure`, `assert_output --partial`, `assert_file_not_exist` from bats-assert/bats-file. Follow the test isolation pattern where each test has its own temp directory via `_common_setup`.

For tests that need `gsd-ralph` to be callable, ensure PATH includes `$PROJECT_ROOT/bin`. The `_common_setup` helper already does this.
  </action>
  <verify>
Run the test suite:
```bash
./tests/bats/bin/bats tests/cleanup.bats
```
All tests pass.
  </verify>
  <done>
tests/cleanup.bats exists with 10+ integration tests covering: help text, missing args, empty registry, single/multiple branch removal, already-removed resources, non-interactive mode, --force flag, signal file cleanup, rollback file cleanup, and registry isolation between phases. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `gsd-ralph cleanup --help` prints usage text
2. `gsd-ralph cleanup 5 --force` removes registered worktrees and branches
3. `gsd-ralph cleanup 5 --force` cleans up signal and rollback files
4. `gsd-ralph cleanup 5 --force` deregisters phase from registry
5. `./tests/bats/bin/bats tests/cleanup.bats` -- all tests pass
6. `./tests/bats/bin/bats tests/execute.bats` -- no regressions
7. Registry entries for other phases are preserved after cleanup
</verification>

<success_criteria>
- `gsd-ralph cleanup N` removes all registered worktrees, branches, signals, and rollback files for phase N
- Only registry-tracked resources are removed (not glob-based)
- Confirmation prompt with --force override
- Graceful handling of already-removed resources
- Integration test suite passes
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-cleanup/05-02-SUMMARY.md`
</output>
